<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>画像を□▨■グリッドに変換（縦横比維持）</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', 'Segoe UI', Roboto, 'メイリオ', sans-serif; padding: 20px; background:#fafafa; color:#111 }
    h1 { font-size:18px }
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
    label { font-size:14px }
    input[type=file] { display:block }
    canvas { display:none }
    pre#output { white-space: pre; font-family: 'Courier New', monospace; font-size:10px; line-height:10px; overflow:auto; background:#fff; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); max-height:60vh }
    .preview { max-width:240px; max-height:240px; border:1px solid #ddd; display:inline-block; vertical-align:top }
    .meta { font-size:13px; color:#444 }
    .btn { padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; transition: background 0.2s }
    .btn:hover { background:#f2f2f2 }
  </style>
</head>
<body>
  <h1>画像を横 <strong>90文字</strong>（または任意の文字数）で □▨■ グリッド化（縦横比維持）</h1>
  <div class="controls">
    <div>
      <label>画像を選択: <input id="file" type="file" accept="image/*"></label>
      <div class="meta">※ 縦横比を維持したまま、指定した横文字数に合わせてリサイズします。</div>
    </div>
  </div>
  <div style="display:flex;gap:12px;align-items:flex-start;">
    <div>
      <div class="meta">横文字数（列数）: <input id="cols" type="number" value="90" style="width:100px"></div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="convert" class="btn">変換</button>
        <button id="copy" class="btn">コピー</button>
        <button id="download" class="btn">テキストをダウンロード</button>
      </div>
      <div style="margin-top:10px; font-size:13px">レンジ: 0–84 → □ , 85–169 → ▨ , 170–255 → ■</div>
    </div>

    <div>
      <div class="preview">
        <canvas id="previewCanvas"></canvas>
      </div>
    </div>
  </div>

  <h2>出力（固定幅フォントで表示）</h2>
  <pre id="output">ここに出力されます。画像を選んで「変換」を押してください。</pre>

  <canvas id="workCanvas"></canvas>

  <script>
    const fileInput = document.getElementById('file');
    const convertBtn = document.getElementById('convert');
    const colsInput = document.getElementById('cols');
    const outputPre = document.getElementById('output');
    const previewCanvas = document.getElementById('previewCanvas');
    const workCanvas = document.getElementById('workCanvas');
    const downloadBtn = document.getElementById('download');
    const copyBtn = document.getElementById('copy');

    let img = null;

    fileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      const i = new Image();
      i.onload = () => {
        img = i;
        const maxSide = 240;
        const aspect = i.width / i.height;
        let w = maxSide, h = maxSide;
        if(aspect >= 1) h = maxSide / aspect; else w = maxSide * aspect;
        previewCanvas.width = w;
        previewCanvas.height = h;
        const pctx = previewCanvas.getContext('2d');
        pctx.drawImage(i, 0, 0, w, h);
        previewCanvas.style.display = 'inline-block';
      };
      i.src = url;
    });

    function luminance(r,g,b){
      return 0.299*r + 0.587*g + 0.114*b;
    }

    convertBtn.addEventListener('click', () => {
      if(!img){ return; }
      let cols = parseInt(colsInput.value,10) || 90;
      if(cols <= 0) return;

      const aspect = img.width / img.height;
      const rows = Math.round(cols / aspect);

      const targetWidth = cols;
      const targetHeight = rows;

      workCanvas.width = targetWidth;
      workCanvas.height = targetHeight;
      const wctx = workCanvas.getContext('2d');
      wctx.drawImage(img, 0, 0, targetWidth, targetHeight);

      const imgData = wctx.getImageData(0,0,targetWidth,targetHeight).data;

      const chars = [];
      for(let y=0; y<targetHeight; y++){
        let line = '';
        for(let x=0; x<targetWidth; x++){
          const idx = (y*targetWidth + x)*4;
          const r = imgData[idx];
          const g = imgData[idx+1];
          const b = imgData[idx+2];
          const lum = luminance(r,g,b);
          let ch;
          if(lum <= 84) ch = '□';
          else if(lum <= 169) ch = '▨';
          else ch = '■';
          line += ch;
        }
        chars.push(line);
      }

      outputPre.textContent = chars.join('\n');

      const pctx = previewCanvas.getContext('2d');
      const w = Math.min(240, targetWidth);
      const h = w / aspect;
      previewCanvas.width = w;
      previewCanvas.height = h;
      pctx.drawImage(workCanvas, 0, 0, w, h);
    });

    copyBtn.addEventListener('click', async () => {
      const text = outputPre.textContent.trim();
      if(!text) return;
      try {
        await navigator.clipboard.writeText(text);
        const original = copyBtn.textContent;
        copyBtn.textContent = '✅ コピー済み';
        setTimeout(() => copyBtn.textContent = original, 1500);
      } catch(e) {
        console.error('コピー失敗', e);
      }
    });

    downloadBtn.addEventListener('click', () => {
      const text = outputPre.textContent;
      if(!text) return;
      const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ascii_grid.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>